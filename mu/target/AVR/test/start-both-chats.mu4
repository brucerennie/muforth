( This file is part of muforth: https://muforth.nimblemachines.com/

  Copyright 2002-2023 David Frech. (Read the LICENSE for details.)

__meta

label setup-task  ( initial pc in x, user area in y)
   ( Create an initial stack frame, including starting PC.)
   y z movw  ( z is our temp "stack pointer")
   -z xl st  -z xh st  ( push pc: big endian!)
   ( push initial regs: 3*2 + 1 for empty descending fixup)
   7 z sbiw  ( reg values are all "don't care")
   0 ,y zl st  1 ,y zh st  ( save temp sp to user area)
   ret  ;c

RESET handler
label start-both-chats
   ( Before we do anything else, let's start with a clean slate.)
   @ram y ldiw  #ram x ldiw  g0 clr  begin  y+ g0 st  1 x sbiw  0= until

   ( Setup temporary stack - so we can call setup-task! - below both task
     stacks.)
   @ram #ram +  64 cells - 1- x ldiw  sp!-unsafe

   i2c-user-area y ldiw
   i2c-chat-task 2/ x ldiw ( starting pc)
   setup-task rcall

   ( switch user areas)  64 xl ldi  xl yl eor
   serial-chat-task 2/ x ldiw  ( starting pc)
   setup-task rcall  restore rjmp  ;c
