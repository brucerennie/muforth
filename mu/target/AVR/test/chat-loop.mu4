( This file is part of muforth: https://muforth.nimblemachines.com/

  Copyright 2002-2023 David Frech. (Read the LICENSE for details.)

( Chat entry and command processing loop.)

__meta
hex

( Compile the first 32 bits of the current muforth Git commit. When asked
  for the version, return these four bytes, in little-endian order.)

here
   muforth-commit drop 8 evaluate  >3210  c, c, c, c,

label version-cmd
   ( here) z ldiw  ret  ;c

label set-addr-cmd
   recv-word rcall  x z movw  ret  ;c


( Host will use set-address to set Z to new SP.)
label run-cmd
   SPH zh out  SPL zl out
   x popw  ( pop status+padding)  SREG xl out
   t popw  x popw  y popw  z popw  ( pop all 4 pointer regs)
   ret  ;c

label get-status-cmd
   SPL xl in  SPH xh in  2 x adiw ( skip ra)  send-word rjmp  ;c

label app-start
label app-stop   ret  ;c

( Command dispatch.)
label command-table
   ( 10) version-cmd       rjmp
   ( 11) set-addr-cmd      rjmp
   ( 12) run-cmd           rjmp
   ( 13) get-status-cmd    rjmp

   ( We want to group the read commands together so "du" can read from the
     current memory "space".)

   ( 14) read-flash-cmd    rjmp  ( space 0)
   ( 15) read-data-cmd     rjmp  ( space 1)
   ( 16) read-eeprom-cmd   rjmp  ( space 2)

   ( 17) write-flash-cmd   rjmp
   ( 18) write-data-cmd    rjmp
   ( 19) write-eeprom-cmd  rjmp

   ( 1a) app-start         rjmp
   ( 1b) app-stop          rjmp
   ;c

label process
   recv-command-byte rcall
   10 xl subi  ( 00 to 0f become large unsigned numbers)
   process command-table - 2/ xl cpi u< if  xh clr
      command-table u2/ ( word address) negate >hilo  xl subi  xh sbci
      xl push  xh push ( big-endian!)
   then ( unknown... return, and get called again)
   ret  ;c

label chat-entry  ( callable from other code!)
   ( Unless host changes it, stacked PC points to caller - usually interact.)
   z pushw  y pushw  x pushw  t pushw  ( push all 4 pointer regs)
   SREG xl in  xh clr  ( padding)  x pushw  ( push status)
   catch rcall  ( capture pc and sp for exceptions)
   begin  process rcall  again  ;c

label interact
   begin  chat-entry rcall  again  ;c

label chat-iic-task
   heart-init rcall  i2c-init rcall
   begin  interact rcall  again  ;c

RESET handler
label setup-chat-iic-task
   ( Create an initial stack frame, including starting PC.)
   our-saved-sp y ldiw  ( point to "user area")
   chat-iic-task 2/ ( initial pc) x ldiw  -y xl st  -y xh st  ( big endian!)
   ( XXX push initial regs)
   2 y sbiw  ( z is don't care)
   status-log x ldiw  -y xh st  -y xl st  ( y is status-log pointer)
   2 y sbiw  ( 0/1 is don't care)
   1 y sbiw ( empty descending stack!)  our-saved-sp y stw  ret  ;c
